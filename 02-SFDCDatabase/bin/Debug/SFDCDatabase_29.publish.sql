/*
Deployment script for SFDC

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "SFDC"
:setvar DefaultFilePrefix "SFDC"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL13.JABBOSA\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL13.JABBOSA\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [master];


GO

IF (DB_ID(N'$(DatabaseName)') IS NOT NULL) 
BEGIN
    ALTER DATABASE [$(DatabaseName)]
    SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
    DROP DATABASE [$(DatabaseName)];
END

GO
PRINT N'Creating $(DatabaseName)...'
GO
CREATE DATABASE [$(DatabaseName)]
    ON 
    PRIMARY(NAME = [$(DatabaseName)], FILENAME = N'$(DefaultDataPath)$(DefaultFilePrefix)_Primary.mdf')
    LOG ON (NAME = [$(DatabaseName)_log], FILENAME = N'$(DefaultLogPath)$(DefaultFilePrefix)_Primary.ldf') COLLATE SQL_Latin1_General_CP1_CI_AS
GO
USE [$(DatabaseName)];


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET ANSI_NULLS ON,
                ANSI_PADDING ON,
                ANSI_WARNINGS ON,
                ARITHABORT ON,
                CONCAT_NULL_YIELDS_NULL ON,
                NUMERIC_ROUNDABORT OFF,
                QUOTED_IDENTIFIER ON,
                ANSI_NULL_DEFAULT ON,
                CURSOR_DEFAULT LOCAL,
                RECOVERY FULL,
                CURSOR_CLOSE_ON_COMMIT OFF,
                AUTO_CREATE_STATISTICS ON,
                AUTO_SHRINK OFF,
                AUTO_UPDATE_STATISTICS ON,
                RECURSIVE_TRIGGERS OFF 
            WITH ROLLBACK IMMEDIATE;
        ALTER DATABASE [$(DatabaseName)]
            SET AUTO_CLOSE OFF 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET ALLOW_SNAPSHOT_ISOLATION OFF;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET READ_COMMITTED_SNAPSHOT OFF 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET AUTO_UPDATE_STATISTICS_ASYNC OFF,
                PAGE_VERIFY NONE,
                DATE_CORRELATION_OPTIMIZATION OFF,
                DISABLE_BROKER,
                PARAMETERIZATION SIMPLE,
                SUPPLEMENTAL_LOGGING OFF 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF IS_SRVROLEMEMBER(N'sysadmin') = 1
    BEGIN
        IF EXISTS (SELECT 1
                   FROM   [master].[dbo].[sysdatabases]
                   WHERE  [name] = N'$(DatabaseName)')
            BEGIN
                EXECUTE sp_executesql N'ALTER DATABASE [$(DatabaseName)]
    SET TRUSTWORTHY OFF,
        DB_CHAINING OFF 
    WITH ROLLBACK IMMEDIATE';
            END
    END
ELSE
    BEGIN
        PRINT N'The database settings cannot be modified. You must be a SysAdmin to apply these settings.';
    END


GO
IF IS_SRVROLEMEMBER(N'sysadmin') = 1
    BEGIN
        IF EXISTS (SELECT 1
                   FROM   [master].[dbo].[sysdatabases]
                   WHERE  [name] = N'$(DatabaseName)')
            BEGIN
                EXECUTE sp_executesql N'ALTER DATABASE [$(DatabaseName)]
    SET HONOR_BROKER_PRIORITY OFF 
    WITH ROLLBACK IMMEDIATE';
            END
    END
ELSE
    BEGIN
        PRINT N'The database settings cannot be modified. You must be a SysAdmin to apply these settings.';
    END


GO
ALTER DATABASE [$(DatabaseName)]
    SET TARGET_RECOVERY_TIME = 0 SECONDS 
    WITH ROLLBACK IMMEDIATE;


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET FILESTREAM(NON_TRANSACTED_ACCESS = OFF),
                CONTAINMENT = NONE 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET AUTO_CREATE_STATISTICS ON(INCREMENTAL = OFF),
                MEMORY_OPTIMIZED_ELEVATE_TO_SNAPSHOT = OFF,
                DELAYED_DURABILITY = DISABLED 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET QUERY_STORE (QUERY_CAPTURE_MODE = ALL, DATA_FLUSH_INTERVAL_SECONDS = 900, INTERVAL_LENGTH_MINUTES = 60, MAX_PLANS_PER_QUERY = 200, CLEANUP_POLICY = (STALE_QUERY_THRESHOLD_DAYS = 367), MAX_STORAGE_SIZE_MB = 100) 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET QUERY_STORE = OFF 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE SCOPED CONFIGURATION SET MAXDOP = 0;
        ALTER DATABASE SCOPED CONFIGURATION FOR SECONDARY SET MAXDOP = PRIMARY;
        ALTER DATABASE SCOPED CONFIGURATION SET LEGACY_CARDINALITY_ESTIMATION = OFF;
        ALTER DATABASE SCOPED CONFIGURATION FOR SECONDARY SET LEGACY_CARDINALITY_ESTIMATION = PRIMARY;
        ALTER DATABASE SCOPED CONFIGURATION SET PARAMETER_SNIFFING = ON;
        ALTER DATABASE SCOPED CONFIGURATION FOR SECONDARY SET PARAMETER_SNIFFING = PRIMARY;
        ALTER DATABASE SCOPED CONFIGURATION SET QUERY_OPTIMIZER_HOTFIXES = OFF;
        ALTER DATABASE SCOPED CONFIGURATION FOR SECONDARY SET QUERY_OPTIMIZER_HOTFIXES = PRIMARY;
    END


GO
IF fulltextserviceproperty(N'IsFulltextInstalled') = 1
    EXECUTE sp_fulltext_database 'enable';


GO
PRINT N'Creating [sfo]...';


GO
CREATE SCHEMA [sfo]
    AUTHORIZATION [dbo];


GO
PRINT N'Creating [ssas]...';


GO
CREATE SCHEMA [ssas]
    AUTHORIZATION [dbo];


GO
PRINT N'Creating [sfo].[Product2]...';


GO
CREATE TABLE [sfo].[Product2] (
    [Id]                     NVARCHAR (18)  NULL,
    [IsDeleted]              BIT            NULL,
    [MasterRecordId]         NVARCHAR (18)  NULL,
    [LastName]               NVARCHAR (80)  NULL,
    [FirstName]              NVARCHAR (40)  NULL,
    [Salutation]             NVARCHAR (40)  NULL,
    [Name]                   NVARCHAR (121) NULL,
    [Title]                  NVARCHAR (128) NULL,
    [Company]                NVARCHAR (255) NULL,
    [Street]                 NVARCHAR (255) NULL,
    [City]                   NVARCHAR (40)  NULL,
    [State]                  NVARCHAR (80)  NULL,
    [PostalCode]             NVARCHAR (20)  NULL,
    [Country]                NVARCHAR (80)  NULL,
    [Latitude]               FLOAT (53)     NULL,
    [Longitude]              FLOAT (53)     NULL,
    [GeocodeAccuracy]        NVARCHAR (40)  NULL,
    [Address]                NVARCHAR (MAX) NULL,
    [Phone]                  NVARCHAR (40)  NULL,
    [MobilePhone]            NVARCHAR (40)  NULL,
    [Fax]                    NVARCHAR (40)  NULL,
    [Email]                  NVARCHAR (80)  NULL,
    [Website]                NVARCHAR (255) NULL,
    [PhotoUrl]               NVARCHAR (255) NULL,
    [Description]            NVARCHAR (MAX) NULL,
    [LeadSource]             NVARCHAR (40)  NULL,
    [Status]                 NVARCHAR (40)  NULL,
    [Industry]               NVARCHAR (40)  NULL,
    [Rating]                 NVARCHAR (40)  NULL,
    [AnnualRevenue]          FLOAT (53)     NULL,
    [NumberOfEmployees]      INT            NULL,
    [OwnerId]                NVARCHAR (18)  NULL,
    [IsConverted]            BIT            NULL,
    [ConvertedDate]          DATE           NULL,
    [ConvertedAccountId]     NVARCHAR (18)  NULL,
    [ConvertedContactId]     NVARCHAR (18)  NULL,
    [ConvertedOpportunityId] NVARCHAR (18)  NULL,
    [IsUnreadByOwner]        BIT            NULL,
    [CreatedDate]            DATETIME       NULL,
    [CreatedById]            NVARCHAR (18)  NULL,
    [LastModifiedDate]       DATETIME       NULL,
    [LastModifiedById]       NVARCHAR (18)  NULL,
    [SystemModstamp]         DATETIME       NULL,
    [LastActivityDate]       DATE           NULL,
    [LastViewedDate]         DATETIME       NULL,
    [LastReferencedDate]     DATETIME       NULL,
    [Jigsaw]                 NVARCHAR (20)  NULL,
    [JigsawContactId]        NVARCHAR (20)  NULL,
    [CleanStatus]            NVARCHAR (40)  NULL,
    [CompanyDunsNumber]      NVARCHAR (9)   NULL,
    [DandbCompanyId]         NVARCHAR (18)  NULL,
    [EmailBouncedReason]     NVARCHAR (255) NULL,
    [EmailBouncedDate]       DATETIME       NULL,
    [SICCode__c]             NVARCHAR (15)  NULL,
    [ProductInterest__c]     NVARCHAR (255) NULL,
    [Primary__c]             NVARCHAR (255) NULL,
    [CurrentGenerators__c]   NVARCHAR (100) NULL,
    [NumberofLocations__c]   FLOAT (53)     NULL
);


GO
PRINT N'Creating [sfo].[Lead]...';


GO
CREATE TABLE [sfo].[Lead] (
    [Id]                     NVARCHAR (18)  NULL,
    [IsDeleted]              BIT            NULL,
    [MasterRecordId]         NVARCHAR (18)  NULL,
    [LastName]               NVARCHAR (80)  NULL,
    [FirstName]              NVARCHAR (40)  NULL,
    [Salutation]             NVARCHAR (40)  NULL,
    [Name]                   NVARCHAR (121) NULL,
    [Title]                  NVARCHAR (128) NULL,
    [Company]                NVARCHAR (255) NULL,
    [Street]                 NVARCHAR (255) NULL,
    [City]                   NVARCHAR (40)  NULL,
    [State]                  NVARCHAR (80)  NULL,
    [PostalCode]             NVARCHAR (20)  NULL,
    [Country]                NVARCHAR (80)  NULL,
    [Latitude]               FLOAT (53)     NULL,
    [Longitude]              FLOAT (53)     NULL,
    [GeocodeAccuracy]        NVARCHAR (40)  NULL,
    [Address]                NVARCHAR (MAX) NULL,
    [Phone]                  NVARCHAR (40)  NULL,
    [MobilePhone]            NVARCHAR (40)  NULL,
    [Fax]                    NVARCHAR (40)  NULL,
    [Email]                  NVARCHAR (80)  NULL,
    [Website]                NVARCHAR (255) NULL,
    [PhotoUrl]               NVARCHAR (255) NULL,
    [Description]            NVARCHAR (MAX) NULL,
    [LeadSource]             NVARCHAR (40)  NULL,
    [Status]                 NVARCHAR (40)  NULL,
    [Industry]               NVARCHAR (40)  NULL,
    [Rating]                 NVARCHAR (40)  NULL,
    [AnnualRevenue]          FLOAT (53)     NULL,
    [NumberOfEmployees]      INT            NULL,
    [OwnerId]                NVARCHAR (18)  NULL,
    [IsConverted]            BIT            NULL,
    [ConvertedDate]          DATE           NULL,
    [ConvertedAccountId]     NVARCHAR (18)  NULL,
    [ConvertedContactId]     NVARCHAR (18)  NULL,
    [ConvertedOpportunityId] NVARCHAR (18)  NULL,
    [IsUnreadByOwner]        BIT            NULL,
    [CreatedDate]            DATETIME       NULL,
    [CreatedById]            NVARCHAR (18)  NULL,
    [LastModifiedDate]       DATETIME       NULL,
    [LastModifiedById]       NVARCHAR (18)  NULL,
    [SystemModstamp]         DATETIME       NULL,
    [LastActivityDate]       DATE           NULL,
    [LastViewedDate]         DATETIME       NULL,
    [LastReferencedDate]     DATETIME       NULL,
    [Jigsaw]                 NVARCHAR (20)  NULL,
    [JigsawContactId]        NVARCHAR (20)  NULL,
    [CleanStatus]            NVARCHAR (40)  NULL,
    [CompanyDunsNumber]      NVARCHAR (9)   NULL,
    [DandbCompanyId]         NVARCHAR (18)  NULL,
    [EmailBouncedReason]     NVARCHAR (255) NULL,
    [EmailBouncedDate]       DATETIME       NULL,
    [SICCode__c]             NVARCHAR (15)  NULL,
    [ProductInterest__c]     NVARCHAR (255) NULL,
    [Primary__c]             NVARCHAR (255) NULL,
    [CurrentGenerators__c]   NVARCHAR (100) NULL,
    [NumberofLocations__c]   FLOAT (53)     NULL
);


GO
PRINT N'Creating [sfo].[Case]...';


GO
CREATE TABLE [sfo].[Case] (
    [Id]                      NVARCHAR (18)  NULL,
    [IsDeleted]               BIT            NULL,
    [CaseNumber]              NVARCHAR (30)  NULL,
    [ContactId]               NVARCHAR (18)  NULL,
    [AccountId]               NVARCHAR (18)  NULL,
    [AssetId]                 NVARCHAR (18)  NULL,
    [ParentId]                NVARCHAR (18)  NULL,
    [SuppliedName]            NVARCHAR (80)  NULL,
    [SuppliedEmail]           NVARCHAR (80)  NULL,
    [SuppliedPhone]           NVARCHAR (40)  NULL,
    [SuppliedCompany]         NVARCHAR (80)  NULL,
    [Type]                    NVARCHAR (40)  NULL,
    [Status]                  NVARCHAR (40)  NULL,
    [Reason]                  NVARCHAR (40)  NULL,
    [Origin]                  NVARCHAR (40)  NULL,
    [Subject]                 NVARCHAR (255) NULL,
    [Priority]                NVARCHAR (40)  NULL,
    [Description]             NVARCHAR (MAX) NULL,
    [IsClosed]                BIT            NULL,
    [ClosedDate]              DATETIME       NULL,
    [IsEscalated]             BIT            NULL,
    [OwnerId]                 NVARCHAR (18)  NULL,
    [CreatedDate]             DATETIME       NULL,
    [CreatedById]             NVARCHAR (18)  NULL,
    [LastModifiedDate]        DATETIME       NULL,
    [LastModifiedById]        NVARCHAR (18)  NULL,
    [SystemModstamp]          DATETIME       NULL,
    [ContactPhone]            NVARCHAR (40)  NULL,
    [ContactMobile]           NVARCHAR (40)  NULL,
    [ContactEmail]            NVARCHAR (80)  NULL,
    [ContactFax]              NVARCHAR (40)  NULL,
    [Comments]                NVARCHAR (MAX) NULL,
    [LastViewedDate]          DATETIME       NULL,
    [LastReferencedDate]      DATETIME       NULL,
    [EngineeringReqNumber__c] NVARCHAR (12)  NULL,
    [SLAViolation__c]         NVARCHAR (255) NULL,
    [Product__c]              NVARCHAR (255) NULL,
    [PotentialLiability__c]   NVARCHAR (255) NULL
);


GO
PRINT N'Creating [sfo].[Contact]...';


GO
CREATE TABLE [sfo].[Contact] (
    [Id]                     NVARCHAR (18)  NULL,
    [IsDeleted]              BIT            NULL,
    [MasterRecordId]         NVARCHAR (18)  NULL,
    [AccountId]              NVARCHAR (18)  NULL,
    [LastName]               NVARCHAR (80)  NULL,
    [FirstName]              NVARCHAR (40)  NULL,
    [Salutation]             NVARCHAR (40)  NULL,
    [Name]                   NVARCHAR (121) NULL,
    [OtherStreet]            NVARCHAR (255) NULL,
    [OtherCity]              NVARCHAR (40)  NULL,
    [OtherState]             NVARCHAR (80)  NULL,
    [OtherPostalCode]        NVARCHAR (20)  NULL,
    [OtherCountry]           NVARCHAR (80)  NULL,
    [OtherLatitude]          FLOAT (53)     NULL,
    [OtherLongitude]         FLOAT (53)     NULL,
    [OtherGeocodeAccuracy]   NVARCHAR (40)  NULL,
    [OtherAddress]           NVARCHAR (MAX) NULL,
    [MailingStreet]          NVARCHAR (255) NULL,
    [MailingCity]            NVARCHAR (40)  NULL,
    [MailingState]           NVARCHAR (80)  NULL,
    [MailingPostalCode]      NVARCHAR (20)  NULL,
    [MailingCountry]         NVARCHAR (80)  NULL,
    [MailingLatitude]        FLOAT (53)     NULL,
    [MailingLongitude]       FLOAT (53)     NULL,
    [MailingGeocodeAccuracy] NVARCHAR (40)  NULL,
    [MailingAddress]         NVARCHAR (MAX) NULL,
    [Phone]                  NVARCHAR (40)  NULL,
    [Fax]                    NVARCHAR (40)  NULL,
    [MobilePhone]            NVARCHAR (40)  NULL,
    [HomePhone]              NVARCHAR (40)  NULL,
    [OtherPhone]             NVARCHAR (40)  NULL,
    [AssistantPhone]         NVARCHAR (40)  NULL,
    [ReportsToId]            NVARCHAR (18)  NULL,
    [Email]                  NVARCHAR (80)  NULL,
    [Title]                  NVARCHAR (128) NULL,
    [Department]             NVARCHAR (80)  NULL,
    [AssistantName]          NVARCHAR (40)  NULL,
    [LeadSource]             NVARCHAR (40)  NULL,
    [Birthdate]              DATE           NULL,
    [Description]            NVARCHAR (MAX) NULL,
    [OwnerId]                NVARCHAR (18)  NULL,
    [CreatedDate]            DATETIME       NULL,
    [CreatedById]            NVARCHAR (18)  NULL,
    [LastModifiedDate]       DATETIME       NULL,
    [LastModifiedById]       NVARCHAR (18)  NULL,
    [SystemModstamp]         DATETIME       NULL,
    [LastActivityDate]       DATE           NULL,
    [LastCURequestDate]      DATETIME       NULL,
    [LastCUUpdateDate]       DATETIME       NULL,
    [LastViewedDate]         DATETIME       NULL,
    [LastReferencedDate]     DATETIME       NULL,
    [EmailBouncedReason]     NVARCHAR (255) NULL,
    [EmailBouncedDate]       DATETIME       NULL,
    [IsEmailBounced]         BIT            NULL,
    [PhotoUrl]               NVARCHAR (255) NULL,
    [Jigsaw]                 NVARCHAR (20)  NULL,
    [JigsawContactId]        NVARCHAR (20)  NULL,
    [CleanStatus]            NVARCHAR (40)  NULL,
    [Level__c]               NVARCHAR (255) NULL,
    [Languages__c]           NVARCHAR (100) NULL
);


GO
PRINT N'Creating [sfo].[User]...';


GO
CREATE TABLE [sfo].[User] (
    [Id]                                                 NVARCHAR (18)   NULL,
    [Username]                                           NVARCHAR (80)   NULL,
    [LastName]                                           NVARCHAR (80)   NULL,
    [FirstName]                                          NVARCHAR (40)   NULL,
    [Name]                                               NVARCHAR (121)  NULL,
    [CompanyName]                                        NVARCHAR (80)   NULL,
    [Division]                                           NVARCHAR (80)   NULL,
    [Department]                                         NVARCHAR (80)   NULL,
    [Title]                                              NVARCHAR (80)   NULL,
    [Street]                                             NVARCHAR (255)  NULL,
    [City]                                               NVARCHAR (40)   NULL,
    [State]                                              NVARCHAR (80)   NULL,
    [PostalCode]                                         NVARCHAR (20)   NULL,
    [Country]                                            NVARCHAR (80)   NULL,
    [Latitude]                                           FLOAT (53)      NULL,
    [Longitude]                                          FLOAT (53)      NULL,
    [GeocodeAccuracy]                                    NVARCHAR (40)   NULL,
    [Address]                                            NVARCHAR (MAX)  NULL,
    [Email]                                              NVARCHAR (128)  NULL,
    [EmailPreferencesAutoBcc]                            BIT             NULL,
    [EmailPreferencesAutoBccStayInTouch]                 BIT             NULL,
    [EmailPreferencesStayInTouchReminder]                BIT             NULL,
    [SenderEmail]                                        NVARCHAR (80)   NULL,
    [SenderName]                                         NVARCHAR (80)   NULL,
    [Signature]                                          NVARCHAR (1333) NULL,
    [StayInTouchSubject]                                 NVARCHAR (80)   NULL,
    [StayInTouchSignature]                               NVARCHAR (512)  NULL,
    [StayInTouchNote]                                    NVARCHAR (512)  NULL,
    [Phone]                                              NVARCHAR (40)   NULL,
    [Fax]                                                NVARCHAR (40)   NULL,
    [MobilePhone]                                        NVARCHAR (40)   NULL,
    [Alias]                                              NVARCHAR (8)    NULL,
    [CommunityNickname]                                  NVARCHAR (40)   NULL,
    [BadgeText]                                          NVARCHAR (80)   NULL,
    [IsActive]                                           BIT             NULL,
    [TimeZoneSidKey]                                     NVARCHAR (40)   NULL,
    [UserRoleId]                                         NVARCHAR (18)   NULL,
    [LocaleSidKey]                                       NVARCHAR (40)   NULL,
    [ReceivesInfoEmails]                                 BIT             NULL,
    [ReceivesAdminInfoEmails]                            BIT             NULL,
    [EmailEncodingKey]                                   NVARCHAR (40)   NULL,
    [ProfileId]                                          NVARCHAR (18)   NULL,
    [UserType]                                           NVARCHAR (40)   NULL,
    [LanguageLocaleKey]                                  NVARCHAR (40)   NULL,
    [EmployeeNumber]                                     NVARCHAR (20)   NULL,
    [DelegatedApproverId]                                NVARCHAR (18)   NULL,
    [ManagerId]                                          NVARCHAR (18)   NULL,
    [LastLoginDate]                                      DATETIME        NULL,
    [LastPasswordChangeDate]                             DATETIME        NULL,
    [CreatedDate]                                        DATETIME        NULL,
    [CreatedById]                                        NVARCHAR (18)   NULL,
    [LastModifiedDate]                                   DATETIME        NULL,
    [LastModifiedById]                                   NVARCHAR (18)   NULL,
    [SystemModstamp]                                     DATETIME        NULL,
    [OfflineTrialExpirationDate]                         DATETIME        NULL,
    [OfflinePdaTrialExpirationDate]                      DATETIME        NULL,
    [UserPermissionsMarketingUser]                       BIT             NULL,
    [UserPermissionsOfflineUser]                         BIT             NULL,
    [UserPermissionsCallCenterAutoLogin]                 BIT             NULL,
    [UserPermissionsMobileUser]                          BIT             NULL,
    [UserPermissionsSFContentUser]                       BIT             NULL,
    [UserPermissionsKnowledgeUser]                       BIT             NULL,
    [UserPermissionsInteractionUser]                     BIT             NULL,
    [UserPermissionsSupportUser]                         BIT             NULL,
    [UserPermissionsJigsawProspectingUser]               BIT             NULL,
    [UserPermissionsSiteforceContributorUser]            BIT             NULL,
    [UserPermissionsSiteforcePublisherUser]              BIT             NULL,
    [UserPermissionsWorkDotComUserFeature]               BIT             NULL,
    [ForecastEnabled]                                    BIT             NULL,
    [UserPreferencesActivityRemindersPopup]              BIT             NULL,
    [UserPreferencesEventRemindersCheckboxDefault]       BIT             NULL,
    [UserPreferencesTaskRemindersCheckboxDefault]        BIT             NULL,
    [UserPreferencesReminderSoundOff]                    BIT             NULL,
    [UserPreferencesDisableAllFeedsEmail]                BIT             NULL,
    [UserPreferencesDisableFollowersEmail]               BIT             NULL,
    [UserPreferencesDisableProfilePostEmail]             BIT             NULL,
    [UserPreferencesDisableChangeCommentEmail]           BIT             NULL,
    [UserPreferencesDisableLaterCommentEmail]            BIT             NULL,
    [UserPreferencesDisProfPostCommentEmail]             BIT             NULL,
    [UserPreferencesContentNoEmail]                      BIT             NULL,
    [UserPreferencesContentEmailAsAndWhen]               BIT             NULL,
    [UserPreferencesApexPagesDeveloperMode]              BIT             NULL,
    [UserPreferencesHideCSNGetChatterMobileTask]         BIT             NULL,
    [UserPreferencesDisableMentionsPostEmail]            BIT             NULL,
    [UserPreferencesDisMentionsCommentEmail]             BIT             NULL,
    [UserPreferencesHideCSNDesktopTask]                  BIT             NULL,
    [UserPreferencesHideChatterOnboardingSplash]         BIT             NULL,
    [UserPreferencesHideSecondChatterOnboardingSplash]   BIT             NULL,
    [UserPreferencesDisCommentAfterLikeEmail]            BIT             NULL,
    [UserPreferencesDisableLikeEmail]                    BIT             NULL,
    [UserPreferencesSortFeedByComment]                   BIT             NULL,
    [UserPreferencesDisableMessageEmail]                 BIT             NULL,
    [UserPreferencesJigsawListUser]                      BIT             NULL,
    [UserPreferencesDisableBookmarkEmail]                BIT             NULL,
    [UserPreferencesDisableSharePostEmail]               BIT             NULL,
    [UserPreferencesEnableAutoSubForFeeds]               BIT             NULL,
    [UserPreferencesDisableFileShareNotificationsForApi] BIT             NULL,
    [UserPreferencesShowTitleToExternalUsers]            BIT             NULL,
    [UserPreferencesShowManagerToExternalUsers]          BIT             NULL,
    [UserPreferencesShowEmailToExternalUsers]            BIT             NULL,
    [UserPreferencesShowWorkPhoneToExternalUsers]        BIT             NULL,
    [UserPreferencesShowMobilePhoneToExternalUsers]      BIT             NULL,
    [UserPreferencesShowFaxToExternalUsers]              BIT             NULL,
    [UserPreferencesShowStreetAddressToExternalUsers]    BIT             NULL,
    [UserPreferencesShowCityToExternalUsers]             BIT             NULL,
    [UserPreferencesShowStateToExternalUsers]            BIT             NULL,
    [UserPreferencesShowPostalCodeToExternalUsers]       BIT             NULL,
    [UserPreferencesShowCountryToExternalUsers]          BIT             NULL,
    [UserPreferencesShowProfilePicToGuestUsers]          BIT             NULL,
    [UserPreferencesShowTitleToGuestUsers]               BIT             NULL,
    [UserPreferencesShowCityToGuestUsers]                BIT             NULL,
    [UserPreferencesShowStateToGuestUsers]               BIT             NULL,
    [UserPreferencesShowPostalCodeToGuestUsers]          BIT             NULL,
    [UserPreferencesShowCountryToGuestUsers]             BIT             NULL,
    [UserPreferencesDisableFeedbackEmail]                BIT             NULL,
    [UserPreferencesDisableWorkEmail]                    BIT             NULL,
    [UserPreferencesHideS1BrowserUI]                     BIT             NULL,
    [UserPreferencesDisableEndorsementEmail]             BIT             NULL,
    [UserPreferencesPathAssistantCollapsed]              BIT             NULL,
    [UserPreferencesCacheDiagnostics]                    BIT             NULL,
    [UserPreferencesShowEmailToGuestUsers]               BIT             NULL,
    [UserPreferencesShowManagerToGuestUsers]             BIT             NULL,
    [UserPreferencesShowWorkPhoneToGuestUsers]           BIT             NULL,
    [UserPreferencesShowMobilePhoneToGuestUsers]         BIT             NULL,
    [UserPreferencesShowFaxToGuestUsers]                 BIT             NULL,
    [UserPreferencesShowStreetAddressToGuestUsers]       BIT             NULL,
    [UserPreferencesLightningExperiencePreferred]        BIT             NULL,
    [UserPreferencesPreviewLightning]                    BIT             NULL,
    [UserPreferencesHideEndUserOnboardingAssistantModal] BIT             NULL,
    [UserPreferencesHideLightningMigrationModal]         BIT             NULL,
    [UserPreferencesHideSfxWelcomeMat]                   BIT             NULL,
    [UserPreferencesHideBiggerPhotoCallout]              BIT             NULL,
    [UserPreferencesGlobalNavBarWTShown]                 BIT             NULL,
    [UserPreferencesGlobalNavGridMenuWTShown]            BIT             NULL,
    [UserPreferencesCreateLEXAppsWTShown]                BIT             NULL,
    [UserPreferencesFavoritesWTShown]                    BIT             NULL,
    [UserPreferencesRecordHomeSectionCollapseWTShown]    BIT             NULL,
    [UserPreferencesRecordHomeReservedWTShown]           BIT             NULL,
    [UserPreferencesFavoritesShowTopFavorites]           BIT             NULL,
    [UserPreferencesExcludeMailAppAttachments]           BIT             NULL,
    [UserPreferencesSuppressTaskSFXReminders]            BIT             NULL,
    [UserPreferencesSuppressEventSFXReminders]           BIT             NULL,
    [UserPreferencesPreviewCustomTheme]                  BIT             NULL,
    [UserPreferencesHasCelebrationBadge]                 BIT             NULL,
    [UserPreferencesUserDebugModePref]                   BIT             NULL,
    [UserPreferencesNewLightningReportRunPageEnabled]    BIT             NULL,
    [ContactId]                                          NVARCHAR (18)   NULL,
    [AccountId]                                          NVARCHAR (18)   NULL,
    [CallCenterId]                                       NVARCHAR (18)   NULL,
    [Extension]                                          NVARCHAR (40)   NULL,
    [FederationIdentifier]                               NVARCHAR (512)  NULL,
    [AboutMe]                                            NVARCHAR (1000) NULL,
    [FullPhotoUrl]                                       NVARCHAR (1024) NULL,
    [SmallPhotoUrl]                                      NVARCHAR (1024) NULL,
    [IsExtIndicatorVisible]                              BIT             NULL,
    [OutOfOfficeMessage]                                 NVARCHAR (40)   NULL,
    [MediumPhotoUrl]                                     NVARCHAR (1024) NULL,
    [DigestFrequency]                                    NVARCHAR (40)   NULL,
    [DefaultGroupNotificationFrequency]                  NVARCHAR (40)   NULL,
    [JigsawImportLimitOverride]                          INT             NULL,
    [LastViewedDate]                                     DATETIME        NULL,
    [LastReferencedDate]                                 DATETIME        NULL,
    [BannerPhotoUrl]                                     NVARCHAR (1024) NULL,
    [SmallBannerPhotoUrl]                                NVARCHAR (1024) NULL,
    [MediumBannerPhotoUrl]                               NVARCHAR (1024) NULL,
    [IsProfilePhotoActive]                               BIT             NULL
);


GO
PRINT N'Creating [sfo].[Opportunity]...';


GO
CREATE TABLE [sfo].[Opportunity] (
    [Id]                            NVARCHAR (18)  NULL,
    [IsDeleted]                     BIT            NULL,
    [AccountId]                     NVARCHAR (18)  NULL,
    [IsPrivate]                     BIT            NULL,
    [Name]                          NVARCHAR (120) NULL,
    [Description]                   NVARCHAR (MAX) NULL,
    [StageName]                     NVARCHAR (40)  NULL,
    [Amount]                        FLOAT (53)     NULL,
    [Probability]                   FLOAT (53)     NULL,
    [ExpectedRevenue]               FLOAT (53)     NULL,
    [TotalOpportunityQuantity]      FLOAT (53)     NULL,
    [CloseDate]                     DATE           NULL,
    [Type]                          NVARCHAR (40)  NULL,
    [NextStep]                      NVARCHAR (255) NULL,
    [LeadSource]                    NVARCHAR (40)  NULL,
    [IsClosed]                      BIT            NULL,
    [IsWon]                         BIT            NULL,
    [ForecastCategory]              NVARCHAR (40)  NULL,
    [ForecastCategoryName]          NVARCHAR (40)  NULL,
    [CampaignId]                    NVARCHAR (18)  NULL,
    [HasOpportunityLineItem]        BIT            NULL,
    [Pricebook2Id]                  NVARCHAR (18)  NULL,
    [OwnerId]                       NVARCHAR (18)  NULL,
    [CreatedDate]                   DATETIME       NULL,
    [CreatedById]                   NVARCHAR (18)  NULL,
    [LastModifiedDate]              DATETIME       NULL,
    [LastModifiedById]              NVARCHAR (18)  NULL,
    [SystemModstamp]                DATETIME       NULL,
    [LastActivityDate]              DATE           NULL,
    [FiscalQuarter]                 INT            NULL,
    [FiscalYear]                    INT            NULL,
    [Fiscal]                        NVARCHAR (6)   NULL,
    [LastViewedDate]                DATETIME       NULL,
    [LastReferencedDate]            DATETIME       NULL,
    [HasOpenActivity]               BIT            NULL,
    [HasOverdueTask]                BIT            NULL,
    [DeliveryInstallationStatus__c] NVARCHAR (255) NULL,
    [TrackingNumber__c]             NVARCHAR (12)  NULL,
    [OrderNumber__c]                NVARCHAR (8)   NULL,
    [CurrentGenerators__c]          NVARCHAR (100) NULL,
    [MainCompetitors__c]            NVARCHAR (100) NULL,
    [MasterRecordId]                NVARCHAR (18)  NULL,
    [LastName]                      NVARCHAR (80)  NULL,
    [FirstName]                     NVARCHAR (40)  NULL,
    [Salutation]                    NVARCHAR (40)  NULL,
    [Title]                         NVARCHAR (128) NULL,
    [Company]                       NVARCHAR (255) NULL,
    [Street]                        NVARCHAR (255) NULL,
    [City]                          NVARCHAR (40)  NULL,
    [State]                         NVARCHAR (80)  NULL,
    [PostalCode]                    NVARCHAR (20)  NULL,
    [Country]                       NVARCHAR (80)  NULL,
    [Latitude]                      FLOAT (53)     NULL,
    [Longitude]                     FLOAT (53)     NULL,
    [GeocodeAccuracy]               NVARCHAR (40)  NULL,
    [Address]                       NVARCHAR (MAX) NULL,
    [Phone]                         NVARCHAR (40)  NULL,
    [MobilePhone]                   NVARCHAR (40)  NULL,
    [Fax]                           NVARCHAR (40)  NULL,
    [Email]                         NVARCHAR (80)  NULL,
    [Website]                       NVARCHAR (255) NULL,
    [PhotoUrl]                      NVARCHAR (255) NULL,
    [Status]                        NVARCHAR (40)  NULL,
    [Industry]                      NVARCHAR (40)  NULL,
    [Rating]                        NVARCHAR (40)  NULL,
    [AnnualRevenue]                 FLOAT (53)     NULL,
    [NumberOfEmployees]             INT            NULL,
    [IsConverted]                   BIT            NULL,
    [ConvertedDate]                 DATE           NULL,
    [ConvertedAccountId]            NVARCHAR (18)  NULL,
    [ConvertedContactId]            NVARCHAR (18)  NULL,
    [ConvertedOpportunityId]        NVARCHAR (18)  NULL,
    [IsUnreadByOwner]               BIT            NULL,
    [Jigsaw]                        NVARCHAR (20)  NULL,
    [JigsawContactId]               NVARCHAR (20)  NULL,
    [CleanStatus]                   NVARCHAR (40)  NULL,
    [CompanyDunsNumber]             NVARCHAR (9)   NULL,
    [DandbCompanyId]                NVARCHAR (18)  NULL,
    [EmailBouncedReason]            NVARCHAR (255) NULL,
    [EmailBouncedDate]              DATETIME       NULL,
    [SICCode__c]                    NVARCHAR (15)  NULL,
    [ProductInterest__c]            NVARCHAR (255) NULL,
    [Primary__c]                    NVARCHAR (255) NULL,
    [NumberofLocations__c]          FLOAT (53)     NULL
);


GO
PRINT N'Creating [dbo].[DimCalendar]...';


GO
CREATE TABLE [dbo].[DimCalendar] (
    [Date]                DATE                NOT NULL,
    [Day]                 TINYINT             NOT NULL,
    [DaySuffix]           CHAR (2)            NOT NULL,
    [Weekday]             TINYINT             NOT NULL,
    [WeekDayName]         VARCHAR (10)        NOT NULL,
    [IsWeekend]           BIT                 NOT NULL,
    [IsHoliday]           BIT                 NOT NULL,
    [HolidayText]         VARCHAR (64) SPARSE NULL,
    [DOWInMonth]          TINYINT             NOT NULL,
    [DayOfYear]           SMALLINT            NOT NULL,
    [WeekOfMonth]         TINYINT             NOT NULL,
    [WeekOfYear]          TINYINT             NOT NULL,
    [ISOWeekOfYear]       TINYINT             NOT NULL,
    [Month]               TINYINT             NOT NULL,
    [MonthName]           VARCHAR (10)        NOT NULL,
    [Quarter]             TINYINT             NOT NULL,
    [QuarterName]         VARCHAR (6)         NOT NULL,
    [Year]                INT                 NOT NULL,
    [MMYYYY]              CHAR (6)            NOT NULL,
    [MonthYear]           CHAR (7)            NOT NULL,
    [FirstDayOfMonth]     DATE                NOT NULL,
    [LastDayOfMonth]      DATE                NOT NULL,
    [FirstDayOfQuarter]   DATE                NOT NULL,
    [LastDayOfQuarter]    DATE                NOT NULL,
    [FirstDayOfYear]      DATE                NOT NULL,
    [LastDayOfYear]       DATE                NOT NULL,
    [FirstDayOfNextMonth] DATE                NOT NULL,
    [FirstDayOfNextYear]  DATE                NOT NULL
);


GO
PRINT N'Creating [ssas].[vwLeads]...';


GO
CREATE VIEW [ssas].[vwLeads]
	AS SELECT LeadSource, IsDeleted, CreatedDate, ConvertedDate FROM sfo.Lead
GO
PRINT N'Creating [ssas].[vwOpportunity]...';


GO
CREATE VIEW [ssas].[vwOpportunity]
	AS SELECT IsDeleted, StageName, CreatedDate, ConvertedDate, CloseDate, LastModifiedDate, LastViewedDate FROM sfo.Opportunity
GO
PRINT N'Creating [ssas].[vwDimCalendar]...';


GO
CREATE VIEW [ssas].[vwDimCalendar]
	AS SELECT [Date], [Month], [Year], [WeekOfYear] FROM dbo.DimCalendar;
GO
PRINT N'Creating [dbo].[fnGetEasterHolidays]...';


GO
CREATE FUNCTION dbo.fnGetEasterHolidays(@year INT) 
RETURNS TABLE
WITH SCHEMABINDING
AS 
RETURN 
(
  WITH x AS 
  (
    SELECT [Date] = CONVERT(DATE, RTRIM(@year) + '0' + RTRIM([Month]) 
        + RIGHT('0' + RTRIM([Day]),2))
      FROM (SELECT [Month], [Day] = DaysToSunday + 28 - (31 * ([Month] / 4))
      FROM (SELECT [Month] = 3 + (DaysToSunday + 40) / 44, DaysToSunday
      FROM (SELECT DaysToSunday = paschal - ((@year + @year / 4 + paschal - 13) % 7)
      FROM (SELECT paschal = epact - (epact / 28)
      FROM (SELECT epact = (24 + 19 * (@year % 19)) % 30) 
        AS epact) AS paschal) AS dts) AS m) AS d
  )
  SELECT [Date], HolidayName = 'Easter Sunday' FROM x
    UNION ALL SELECT DATEADD(DAY,-2,[Date]), 'Good Friday'   FROM x
    UNION ALL SELECT DATEADD(DAY, 1,[Date]), 'Easter Monday' FROM x
);
GO
PRINT N'Creating [dbo].[fnDateRange]...';


GO
CREATE FUNCTION [dbo].[fnDateRange]
(     
      @Increment              CHAR(1),
      @StartDate              DATETIME,
      @EndDate                DATETIME
)
RETURNS  
@SelectedRange    TABLE 
(IndividualDate DATETIME)
AS 
BEGIN
      ;WITH cteRange (DateRange) AS (
            SELECT @StartDate
            UNION ALL
            SELECT 
                  CASE
                        WHEN @Increment = 'd' THEN DATEADD(dd, 1, DateRange)
                        WHEN @Increment = 'w' THEN DATEADD(ww, 1, DateRange)
                        WHEN @Increment = 'm' THEN DATEADD(mm, 1, DateRange)
                  END
            FROM cteRange
            WHERE DateRange <= 
                  CASE
                        WHEN @Increment = 'd' THEN DATEADD(dd, -1, @EndDate)
                        WHEN @Increment = 'w' THEN DATEADD(ww, -1, @EndDate)
                        WHEN @Increment = 'm' THEN DATEADD(mm, -1, @EndDate)
                  END)
          
      INSERT INTO @SelectedRange (IndividualDate)
      SELECT DateRange
      FROM cteRange
      OPTION (MAXRECURSION 3660);
      RETURN
END
GO
/*
Post-Deployment Script Template							
--------------------------------------------------------------------------------------
 This file contains SQL statements that will be appended to the build script.		
 Use SQLCMD syntax to include a file in the post-deployment script.			
 Example:      :r .\myfile.sql								
 Use SQLCMD syntax to reference a variable in the post-deployment script.		
 Example:      :setvar TableName MyTable							
               SELECT * FROM [$(TableName)]					
--------------------------------------------------------------------------------------
*/
DECLARE @StartDate DATE = '20000101', @NumberOfYears INT = 30;

-- prevent set or regional settings from interfering with 
-- interpretation of dates / literals

SET DATEFIRST 7;
SET DATEFORMAT mdy;
SET LANGUAGE US_ENGLISH;

DECLARE @CutoffDate DATE = DATEADD(YEAR, @NumberOfYears, @StartDate);

-- this is just a holding table for intermediate calculations:

CREATE TABLE #dim
(
  [date]       DATE PRIMARY KEY, 
  [day]        AS DATEPART(DAY,      [date]),
  [month]      AS DATEPART(MONTH,    [date]),
  FirstOfMonth AS CONVERT(DATE, DATEADD(MONTH, DATEDIFF(MONTH, 0, [date]), 0)),
  [MonthName]  AS DATENAME(MONTH,    [date]),
  [week]       AS DATEPART(WEEK,     [date]),
  [ISOweek]    AS DATEPART(ISO_WEEK, [date]),
  [DayOfWeek]  AS DATEPART(WEEKDAY,  [date]),
  [quarter]    AS DATEPART(QUARTER,  [date]),
  [year]       AS DATEPART(YEAR,     [date]),
  FirstOfYear  AS CONVERT(DATE, DATEADD(YEAR,  DATEDIFF(YEAR,  0, [date]), 0)),
  Style112     AS CONVERT(CHAR(8),   [date], 112),
  Style101     AS CONVERT(CHAR(10),  [date], 101)
);

-- use the catalog views to generate as many rows as we need

INSERT #dim([date]) 
SELECT d
FROM
(
  SELECT d = DATEADD(DAY, rn - 1, @StartDate)
  FROM 
  (
    SELECT TOP (DATEDIFF(DAY, @StartDate, @CutoffDate)) 
      rn = ROW_NUMBER() OVER (ORDER BY s1.[object_id])
    FROM sys.all_objects AS s1
    CROSS JOIN sys.all_objects AS s2
    -- on my system this would support > 5 million days
    ORDER BY s1.[object_id]
  ) AS x
) AS y

GO

INSERT dbo.DimCalendar WITH (TABLOCKX)
SELECT
  --DateKey     = CONVERT(INT, Style112),
  [Date]        = [date],
  [Day]         = CONVERT(TINYINT, [day]),
  DaySuffix     = CONVERT(CHAR(2), CASE WHEN [day] / 10 = 1 THEN 'th' ELSE 
                  CASE RIGHT([day], 1) WHEN '1' THEN 'st' WHEN '2' THEN 'nd' 
	              WHEN '3' THEN 'rd' ELSE 'th' END END),
  [Weekday]     = CONVERT(TINYINT, [DayOfWeek]),
  [WeekDayName] = CONVERT(VARCHAR(10), DATENAME(WEEKDAY, [date])),
  [IsWeekend]   = CONVERT(BIT, CASE WHEN [DayOfWeek] IN (1,7) THEN 1 ELSE 0 END),
  [IsHoliday]   = CONVERT(BIT, 0),
  HolidayText   = CONVERT(VARCHAR(64), NULL),
  [DOWInMonth]  = CONVERT(TINYINT, ROW_NUMBER() OVER 
                  (PARTITION BY FirstOfMonth, [DayOfWeek] ORDER BY [date])),
  [DayOfYear]   = CONVERT(SMALLINT, DATEPART(DAYOFYEAR, [date])),
  WeekOfMonth   = CONVERT(TINYINT, DENSE_RANK() OVER 
                  (PARTITION BY [year], [month] ORDER BY [week])),
  WeekOfYear    = CONVERT(TINYINT, [week]),
  ISOWeekOfYear = CONVERT(TINYINT, ISOWeek),
  [Month]       = CONVERT(TINYINT, [month]),
  [MonthName]   = CONVERT(VARCHAR(10), [MonthName]),
  [Quarter]     = CONVERT(TINYINT, [quarter]),
  QuarterName   = CONVERT(VARCHAR(6), CASE [quarter] WHEN 1 THEN 'First' 
                  WHEN 2 THEN 'Second' WHEN 3 THEN 'Third' WHEN 4 THEN 'Fourth' END), 
  [Year]        = [year],
  MMYYYY        = CONVERT(CHAR(6), LEFT(Style101, 2)    + LEFT(Style112, 4)),
  MonthYear     = CONVERT(CHAR(7), LEFT([MonthName], 3) + LEFT(Style112, 4)),
  FirstDayOfMonth     = FirstOfMonth,
  LastDayOfMonth      = MAX([date]) OVER (PARTITION BY [year], [month]),
  FirstDayOfQuarter   = MIN([date]) OVER (PARTITION BY [year], [quarter]),
  LastDayOfQuarter    = MAX([date]) OVER (PARTITION BY [year], [quarter]),
  FirstDayOfYear      = FirstOfYear,
  LastDayOfYear       = MAX([date]) OVER (PARTITION BY [year]),
  FirstDayOfNextMonth = DATEADD(MONTH, 1, FirstOfMonth),
  FirstDayOfNextYear  = DATEADD(YEAR,  1, FirstOfYear)
FROM #dim
OPTION (MAXDOP 1);

GO

;WITH x AS 
(
  SELECT /* DateKey, */ [Date], IsHoliday, HolidayText, FirstDayOfYear,
    DOWInMonth, [MonthName], [WeekDayName], [Day],
    LastDOWInMonth = ROW_NUMBER() OVER 
    (
      PARTITION BY FirstDayOfMonth, [Weekday] 
      ORDER BY [Date] DESC
    )
  FROM dbo.DimCalendar
)
UPDATE x SET IsHoliday = 1, HolidayText = CASE
  WHEN ([Date] = FirstDayOfYear) 
    THEN 'New Year''s Day'
  WHEN ([DOWInMonth] = 3 AND [MonthName] = 'January' AND [WeekDayName] = 'Monday')
    THEN 'Martin Luther King Day'    -- (3rd Monday in January)
  WHEN ([DOWInMonth] = 3 AND [MonthName] = 'February' AND [WeekDayName] = 'Monday')
    THEN 'President''s Day'          -- (3rd Monday in February)
  WHEN ([LastDOWInMonth] = 1 AND [MonthName] = 'May' AND [WeekDayName] = 'Monday')
    THEN 'Memorial Day'              -- (last Monday in May)
  WHEN ([MonthName] = 'July' AND [Day] = 4)
    THEN 'Independence Day'          -- (July 4th)
  WHEN ([DOWInMonth] = 1 AND [MonthName] = 'September' AND [WeekDayName] = 'Monday')
    THEN 'Labour Day'                -- (first Monday in September)
  WHEN ([DOWInMonth] = 2 AND [MonthName] = 'October' AND [WeekDayName] = 'Monday')
    THEN 'Columbus Day'              -- Columbus Day (second Monday in October)
  WHEN ([MonthName] = 'November' AND [Day] = 11)
    THEN 'Veterans'' Day'            -- Veterans' Day (November 11th)
  WHEN ([DOWInMonth] = 4 AND [MonthName] = 'November' AND [WeekDayName] = 'Thursday')
    THEN 'Thanksgiving Day'          -- Thanksgiving Day (fourth Thursday in November)
  WHEN ([MonthName] = 'December' AND [Day] = 25)
    THEN 'Christmas Day'
  END
WHERE 
  ([Date] = FirstDayOfYear)
  OR ([DOWInMonth] = 3     AND [MonthName] = 'January'   AND [WeekDayName] = 'Monday')
  OR ([DOWInMonth] = 3     AND [MonthName] = 'February'  AND [WeekDayName] = 'Monday')
  OR ([LastDOWInMonth] = 1 AND [MonthName] = 'May'       AND [WeekDayName] = 'Monday')
  OR ([MonthName] = 'July' AND [Day] = 4)
  OR ([DOWInMonth] = 1     AND [MonthName] = 'September' AND [WeekDayName] = 'Monday')
  OR ([DOWInMonth] = 2     AND [MonthName] = 'October'   AND [WeekDayName] = 'Monday')
  OR ([MonthName] = 'November' AND [Day] = 11)
  OR ([DOWInMonth] = 4     AND [MonthName] = 'November' AND [WeekDayName] = 'Thursday')
  OR ([MonthName] = 'December' AND [Day] = 25);

GO

UPDATE d SET IsHoliday = 1, HolidayText = 'Black Friday'
FROM dbo.DimCalendar AS d
INNER JOIN
(
  SELECT /* DateKey, */ [Date], [Year], [DayOfYear]
  FROM dbo.DimCalendar 
  WHERE HolidayText = 'Thanksgiving Day'
) AS src 
ON d.[Year] = src.[Year] 
AND d.[DayOfYear] = src.[DayOfYear] + 1;

GO

;WITH x AS 
(
  SELECT d.[Date], d.IsHoliday, d.HolidayText, h.HolidayName
    FROM dbo.DimCalendar AS d
    CROSS APPLY dbo.fnGetEasterHolidays(d.[Year]) AS h
    WHERE d.[Date] = h.[Date]
)
UPDATE x SET IsHoliday = 1, HolidayText = HolidayName;
GO

GO
DECLARE @VarDecimalSupported AS BIT;

SELECT @VarDecimalSupported = 0;

IF ((ServerProperty(N'EngineEdition') = 3)
    AND (((@@microsoftversion / power(2, 24) = 9)
          AND (@@microsoftversion & 0xffff >= 3024))
         OR ((@@microsoftversion / power(2, 24) = 10)
             AND (@@microsoftversion & 0xffff >= 1600))))
    SELECT @VarDecimalSupported = 1;

IF (@VarDecimalSupported > 0)
    BEGIN
        EXECUTE sp_db_vardecimal_storage_format N'$(DatabaseName)', 'ON';
    END


GO
PRINT N'Update complete.';


GO
